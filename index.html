<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Orçamentos PRIN 3D</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais para o Firebase
        window.firebaseApp = null;
        window.firestoreDb = null;
        window.firestoreAuth = null;
        window.currentUserId = null;
        window.isAuthReady = false;

        // Função para inicializar o Firebase
        window.initializeFirebase = async () => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            // CORREÇÃO: Usar __initial_auth_token no lado direito da expressão.
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            try {
                window.firebaseApp = initializeApp(firebaseConfig);
                window.firestoreDb = getFirestore(window.firebaseApp);
                window.firestoreAuth = getAuth(window.firebaseApp);

                onAuthStateChanged(window.firestoreAuth, async (user) => {
                    if (user) {
                        window.currentUserId = user.uid;
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(window.firestoreAuth, initialAuthToken);
                            } else {
                                await signInAnonymously(window.firestoreAuth);
                            }
                        } catch (error) {
                            console.error("Erro ao autenticar no Firebase:", error);
                            showMessageBox("Erro ao conectar com o servidor de autenticação. Tente novamente mais tarde.");
                        }
                        window.currentUserId = window.firestoreAuth.currentUser?.uid || crypto.randomUUID();
                    }
                    window.isAuthReady = true;
                    // Chamar a função para carregar templates e renderizar após a autenticação
                    loadSavedTemplates();
                });
            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                showMessageBox("Erro na inicialização do Firebase. Verifique a configuração.");
            }
        };

        // Funções Firestore (disponibilizadas globalmente)
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.onSnapshot = onSnapshot;
        window.addDoc = addDoc;
        window.doc = doc;
        window.deleteDoc = deleteDoc;
    </script>
    <!-- html2canvas CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
            xintegrity="sha512-BNaRQnYJtSwHD3H7lFTNAsnpakIRVcOQIRpnADuFVcbPHzVcFxXFLpvN3ru0ppS5JAwHTyJVhFPUGfdFrHhFXg==
            "crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* Estilos específicos para impressão */
        @media print {
            body > *:not(.budget-preview-container) {
                display: none !important;
            }
            .budget-preview-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background-color: white;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
                overflow: visible;
            }
            .budget-preview-container .print\:hidden {
                display: none !important;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8 flex items-center justify-center font-sans">

    <!-- Caixa de Mensagem -->
    <div id="message-box" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="message-content" class="text-gray-800 text-lg mb-4"></p>
            <button id="message-ok-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                OK
            </button>
        </div>
    </div>

    <!-- Preview do Orçamento para Impressão -->
    <div id="budget-preview-container" class="fixed inset-0 bg-white p-4 sm:p-8 overflow-auto z-40 hidden budget-preview-container">
        <div class="max-w-full sm:max-w-lg md:max-w-3xl mx-auto bg-white p-6 sm:p-8 rounded-lg shadow-xl print:shadow-none print:border-none">
            <div class="flex justify-between items-center mb-8 print:hidden">
                <h2 class="text-3xl font-bold text-gray-800">Visualização do Orçamento</h2>
                <div>
                    <button id="generate-image-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105 mr-2">
                        Gerar Imagem (PNG)
                    </button>
                    <button id="close-preview-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105">
                        Fechar Visualização
                    </button>
                </div>
            </div>

            <!-- Conteúdo do Orçamento para Impressão (com ref para captura) -->
            <div id="budget-content-to-capture" class="p-6 border border-gray-300 rounded-lg bg-white">
                <div class="flex flex-col items-center mb-8">
                    <img id="company-logo" src="https://res.cloudinary.com/dwewtoo86/image/upload/v1755360712/Texto_do_seu_par%C3%A1grafo_2_ewy6lv.png" alt="PRIN 3D Logo" class="h-24 mb-4 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/100x100/A0A0A0/FFFFFF?text=PRIN3D'">
                    <h1 class="text-4xl font-extrabold text-center text-gray-900">PRIN 3D</h1>
                    <h2 class="text-2xl font-bold text-center text-gray-800 mt-2">ORÇAMENTO</h2>
                </div>

                <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div class="mb-4 sm:mb-0">
                        <p class="text-lg text-gray-700">Data: <span id="budget-date"></span></p>
                        <p class="text-lg text-gray-700">Emitido por: <span id="budget-user-id"></span></p>
                    </div>
                    <div class="text-left sm:text-right w-full sm:w-auto">
                        <p class="text-lg font-semibold text-gray-800">Cliente:</p>
                        <p class="text-md text-gray-700" id="preview-client-name"></p>
                        <p class="text-md text-gray-700" id="preview-client-phone"></p>
                    </div>
                </div>

                <div class="overflow-x-auto"> <!-- Adicionado para responsividade da tabela -->
                    <table class="min-w-full bg-white border border-gray-300 mb-8">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-3 px-4 border-b border-gray-300 text-left text-sm font-semibold text-gray-700 uppercase">Item</th>
                                <th class="py-3 px-4 border-b border-gray-300 text-center text-sm font-semibold text-gray-700 uppercase">Qtd</th>
                                <th class="py-3 px-4 border-b border-gray-300 text-right text-sm font-semibold text-gray-700 uppercase">Preço Unit.</th>
                                <th class="py-3 px-4 border-b border-gray-300 text-right text-sm font-semibold text-gray-700 uppercase">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="budget-items-preview">
                            <!-- Itens do orçamento serão renderizados aqui -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colSpan="3" class="py-4 px-4 text-right text-xl font-bold text-gray-900">Total Geral:</td>
                                <td class="py-4 px-4 text-right text-2xl font-extrabold text-blue-700" id="budget-total-preview"></td>
                            </tr>
                            <tr>
                                <td colSpan="3" class="py-2 px-4 text-right text-xl font-bold text-gray-900 border-t border-gray-300">Entrada (50%):</td>
                                <td class="py-2 px-4 text-right text-2xl font-extrabold text-green-700 border-t border-gray-300" id="budget-downpayment-preview"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <p class="text-gray-600 text-sm mt-8 text-center italic">
                    Este é um orçamento gerado automaticamente. Valores sujeitos a confirmação.
                    <br />
                    **Para registro do pedido e início da produção, é necessário o pagamento de 50% do valor total como entrada.**
                </p>
            </div>
          </div>
        </div>

    <!-- Conteúdo principal do aplicativo -->
    <div id="main-app-container" class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-lg">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Gerador de Orçamentos</h1>

        <!-- Exibição do ID do Usuário -->
        <p class="text-sm text-gray-600 text-center mb-4 break-all">
            Seu ID de Usuário: <span id="display-user-id" class="font-mono bg-gray-200 px-2 py-1 rounded">Carregando...</span>
        </p>

        <!-- Campos para dados do cliente -->
        <div class="mb-8 p-4 border border-gray-200 rounded-md bg-yellow-50">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Dados do Cliente</h2>
            <div class="mb-4">
                <label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">
                    Nome do Cliente:
                </label>
                <input
                    type="text"
                    id="clientName"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm"
                    placeholder="Ex: João da Silva"
                />
            </div>
            <div class="mb-4">
                <label for="clientPhone" class="block text-sm font-medium text-gray-700 mb-1">
                    Telefone para Contato:
                </label>
                <input
                    type="tel"
                    id="clientPhone"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm"
                    placeholder="Ex: (XX) XXXXX-XXXX"
                />
            </div>
        </div>

        <!-- Formulário para adicionar novos itens ao orçamento -->
        <form id="add-item-form" class="mb-8 p-4 border border-gray-200 rounded-md bg-gray-50">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Novo Item ao Orçamento</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="itemName" class="block text-sm font-medium text-gray-700 mb-1">
                        Nome do Item:
                    </label>
                    <input
                        type="text"
                        id="itemName"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        placeholder="Ex: Serviço de consultoria"
                        required
                    />
                </div>
                <div>
                    <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">
                        Quantidade:
                    </label>
                    <input
                        type="number"
                        id="quantity"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        placeholder="Ex: 1"
                        min="1"
                        required
                    />
                </div>
            </div>
            <div class="mb-4">
                <label for="unitPrice" class="block text-sm font-medium text-gray-700 mb-1">
                    Preço Unitário: (R$)
                </label>
                <input
                    type="number"
                    id="unitPrice"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    placeholder="Ex: 50.00"
                    step="0.01"
                    min="0.01"
                    required
                />
            </div>
            <button
                type="submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105"
            >
                Adicionar Item
            </button>
        </form>

        <!-- Seção para salvar novos templates -->
        <form id="save-template-form" class="mb-8 p-4 border border-gray-200 rounded-md bg-green-50">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Salvar Novo Item como Template</h2>
            <div class="mb-4">
                <label for="templateName" class="block text-sm font-medium text-gray-700 mb-1">
                    Nome do Template:
                </label>
                <input
                    type="text"
                    id="templateName"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
                    placeholder="Ex: Consultoria Básica"
                    required
                />
            </div>
            <div class="mb-4">
                <label for="templateUnitPrice" class="block text-sm font-medium text-gray-700 mb-1">
                    Preço Unitário do Template: (R$)
                </label>
                <input
                    type="number"
                    id="templateUnitPrice"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
                    placeholder="Ex: 75.00"
                    step="0.01"
                    min="0.01"
                    required
                />
            </div>
            <button
                type="submit"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105"
            >
                Salvar Template
            </button>
        </form>

        <!-- Seção para adicionar itens salvos ao orçamento -->
        <div class="mb-8 p-4 border border-gray-200 rounded-md bg-blue-50">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Item Salvo ao Orçamento</h2>
            <div class="mb-4">
                <label for="selectTemplate" class="block text-sm font-medium text-gray-700 mb-1">
                    Selecionar Template:
                </label>
                <select
                    id="selectTemplate"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                >
                    <option value="">-- Selecione um Template --</option>
                    <!-- Templates serão carregados aqui -->
                </select>
            </div>
            <div class="mb-4">
                <label for="selectedTemplateQuantity" class="block text-sm font-medium text-gray-700 mb-1">
                    Quantidade:
                </label>
                <input
                    type="number"
                    id="selectedTemplateQuantity"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    placeholder="Ex: 1"
                    min="1"
                />
            </div>
            <button
                id="add-template-to-budget-button"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105"
            >
                Adicionar do Template
            </button>
        </div>

        <!-- Lista de templates salvos -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Meus Templates Salvos</h2>
            <ul id="saved-templates-list" class="divide-y divide-gray-200 border border-gray-200 rounded-md">
                <!-- Templates salvos serão renderizados aqui -->
            </ul>
        </div>

        <!-- Lista de itens do orçamento atual -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Itens do Orçamento Atual</h2>
            <ul id="current-budget-items-list" class="divide-y divide-gray-200 border border-gray-200 rounded-md">
                <!-- Itens do orçamento atual serão renderizados aqui -->
            </ul>
        </div>

        <!-- Resumo do total do orçamento -->
        <div class="border-t-2 border-gray-300 pt-4 mt-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Total do Orçamento:</h2>
                <p class="text-2xl font-bold text-blue-700" id="current-total"></p>
            </div>
            <button
                id="generate-budget-button"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105"
            >
                Gerar Orçamento para Cliente
            </button>
        </div>
    </div>

    <script type="text/javascript">
        // Variáveis de estado globais (substituem useState do React)
        let items = [];
        let savedTemplates = [];
        let total = 0;
        let clientName = '';
        let clientPhone = '';
        let message = '';
        let showBudgetPreview = false;

        // Referências a elementos DOM
        const messageBox = document.getElementById('message-box');
        const messageContent = document.getElementById('message-content');
        const messageOkButton = document.getElementById('message-ok-button');
        const mainAppContainer = document.getElementById('main-app-container');
        const budgetPreviewContainer = document.getElementById('budget-preview-container');
        const budgetContentToCapture = document.getElementById('budget-content-to-capture');

        const itemNameInput = document.getElementById('itemName');
        const quantityInput = document.getElementById('quantity');
        const unitPriceInput = document.getElementById('unitPrice');
        const addItemForm = document.getElementById('add-item-form');
        const currentBudgetItemsList = document.getElementById('current-budget-items-list');
        const currentTotalDisplay = document.getElementById('current-total');

        const templateNameInput = document.getElementById('templateName');
        const templateUnitPriceInput = document.getElementById('templateUnitPrice');
        const saveTemplateForm = document.getElementById('save-template-form');
        const savedTemplatesList = document.getElementById('saved-templates-list');
        const selectTemplateDropdown = document.getElementById('selectTemplate');
        const selectedTemplateQuantityInput = document.getElementById('selectedTemplateQuantity');
        const addTemplateToBudgetButton = document.getElementById('add-template-to-budget-button');

        const clientNameInput = document.getElementById('clientName');
        const clientPhoneInput = document.getElementById('clientPhone');

        const generateBudgetButton = document.getElementById('generate-budget-button');
        const generateImageButton = document.getElementById('generate-image-button');
        const closePreviewButton = document.getElementById('close-preview-button');

        const companyName = "PRIN 3D";
        const companyLogo = "https://res.cloudinary.com/dwewtoo86/image/upload/v1755360712/Texto_do_seu_par%C3%A1grafo_2_ewy6lv.png";

        // --- Funções de Ajuda ---

        function showMessageBox(msg) {
            messageContent.textContent = msg;
            messageBox.classList.remove('hidden');
        }

        function hideMessageBox() {
            messageBox.classList.add('hidden');
            messageContent.textContent = '';
        }

        function calculateTotal() {
            total = items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            currentTotalDisplay.textContent = `R$ ${total.toFixed(2)}`;
        }

        function renderBudgetItems() {
            currentBudgetItemsList.innerHTML = ''; // Limpa a lista
            if (items.length === 0) {
                currentBudgetItemsList.innerHTML = '<p class="text-gray-500 text-center italic p-4">Nenhum item adicionado ao orçamento ainda.</p>';
            } else {
                items.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.className = 'p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center';
                    listItem.innerHTML = `
                        <div class="mb-2 sm:mb-0">
                            <p class="text-lg font-medium text-gray-900">${item.name}</p>
                            <p class="text-sm text-gray-600">
                                ${item.quantity} x R$ ${item.unitPrice.toFixed(2)} = R$ ${(item.quantity * item.unitPrice).toFixed(2)}
                            </p>
                        </div>
                        <button data-id="${item.id}" class="remove-item-button bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-1 px-3 rounded-md transition duration-300 ease-in-out">
                            Remover
                        </button>
                    `;
                    currentBudgetItemsList.appendChild(listItem);
                });
                // Adiciona event listeners aos novos botões de remoção
                document.querySelectorAll('.remove-item-button').forEach(button => {
                    button.onclick = (e) => handleRemoveItem(parseFloat(e.target.dataset.id));
                });
            }
            calculateTotal();
        }

        async function loadSavedTemplates() {
            if (!window.firestoreDb || !window.currentUserId || !window.isAuthReady) {
                // Tentar carregar novamente se Firebase não estiver pronto
                // ou mostrar mensagem de carregamento/erro.
                savedTemplatesList.innerHTML = '<p class="text-gray-500 text-center italic p-4">Carregando templates...</p>';
                selectTemplateDropdown.innerHTML = '<option value="">-- Carregando Templates --</option>';
                return;
            }

            const templatesRef = window.collection(window.firestoreDb, `artifacts/${__app_id}/users/${window.currentUserId}/savedTemplates`);
            window.onSnapshot(templatesRef, (snapshot) => {
                savedTemplates = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderSavedTemplates();
                populateTemplateDropdown();
            }, (error) => {
                console.error("Erro ao carregar templates salvos:", error);
                showMessageBox("Erro ao carregar itens salvos.");
            });
        }

        function renderSavedTemplates() {
            savedTemplatesList.innerHTML = '';
            if (savedTemplates.length === 0) {
                savedTemplatesList.innerHTML = '<p class="text-gray-500 text-center italic p-4">Nenhum template salvo ainda.</p>';
            } else {
                savedTemplates.forEach(template => {
                    const listItem = document.createElement('li');
                    listItem.className = 'p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center';
                    listItem.innerHTML = `
                        <div class="mb-2 sm:mb-0">
                            <p class="text-lg font-medium text-gray-900">${template.name}</p>
                            <p class="text-sm text-gray-600">
                                R$ ${template.unitPrice.toFixed(2)}
                            </p>
                        </div>
                        <button data-id="${template.id}" class="delete-template-button bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-1 px-3 rounded-md transition duration-300 ease-in-out">
                            Remover Template
                        </button>
                    `;
                    savedTemplatesList.appendChild(listItem);
                });
                document.querySelectorAll('.delete-template-button').forEach(button => {
                    button.onclick = (e) => handleDeleteTemplate(e.target.dataset.id);
                });
            }
        }

        function populateTemplateDropdown() {
            selectTemplateDropdown.innerHTML = '<option value="">-- Selecione um Template --</option>';
            savedTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.name} (R$ ${template.unitPrice.toFixed(2)})`;
                selectTemplateDropdown.appendChild(option);
            });
        }

        // --- Funções de Manipulação de Eventos ---

        messageOkButton.onclick = hideMessageBox;

        // Inicialização do Firebase e carregamento de templates
        window.onload = () => {
            window.initializeFirebase().then(() => {
                // Atualiza o ID do usuário após a autenticação
                document.getElementById('display-user-id').textContent = window.currentUserId;
            });
        };

        addItemForm.onsubmit = (e) => {
            e.preventDefault();
            const itemName = itemNameInput.value.trim();
            const quantity = parseFloat(quantityInput.value);
            const unitPrice = parseFloat(unitPriceInput.value);

            if (itemName === '' || quantity <= 0 || unitPrice <= 0) {
                showMessageBox('Por favor, preencha todos os campos corretamente (quantidade e preço devem ser maiores que zero).');
                return;
            }

            const newItem = {
                id: Date.now(),
                name: itemName,
                quantity: quantity,
                unitPrice: unitPrice,
            };

            items.push(newItem);
            renderBudgetItems();
            itemNameInput.value = '';
            quantityInput.value = '';
            unitPriceInput.value = '';
        };

        function handleRemoveItem(id) {
            items = items.filter(item => item.id !== id);
            renderBudgetItems();
        }

        saveTemplateForm.onsubmit = async (e) => {
            e.preventDefault();
            const templateName = templateNameInput.value.trim();
            const templateUnitPrice = parseFloat(templateUnitPriceInput.value);

            if (!window.firestoreDb || !window.currentUserId) {
                showMessageBox('Erro: Banco de dados não disponível ou usuário não autenticado. Tente recarregar a página.');
                return;
            }
            if (templateName === '' || templateUnitPrice <= 0) {
                showMessageBox('Por favor, preencha o nome do template e um preço unitário válido.');
                return;
            }

            try {
                const savedTemplatesCollectionRef = window.collection(window.firestoreDb, `artifacts/${__app_id}/users/${window.currentUserId}/savedTemplates`);
                await window.addDoc(savedTemplatesCollectionRef, {
                    name: templateName,
                    unitPrice: templateUnitPrice,
                    createdAt: new Date(),
                });
                showMessageBox('Item salvo como template com sucesso!');
                templateNameInput.value = '';
                templateUnitPriceInput.value = '';
            } catch (error) {
                console.error("Erro ao salvar template:", error);
                showMessageBox("Erro ao salvar o item como template.");
            }
        };

        addTemplateToBudgetButton.onclick = () => {
            const selectedTemplateId = selectTemplateDropdown.value;
            const selectedTemplateQuantity = parseFloat(selectedTemplateQuantityInput.value);

            if (selectedTemplateId === '' || selectedTemplateQuantity <= 0) {
                showMessageBox('Por favor, selecione um template e insira uma quantidade válida.');
                return;
            }

            const templateToAdd = savedTemplates.find(template => template.id === selectedTemplateId);
            if (templateToAdd) {
                const newItem = {
                    id: Date.now(),
                    name: templateToAdd.name,
                    quantity: selectedTemplateQuantity,
                    unitPrice: templateToAdd.unitPrice,
                };
                items.push(newItem);
                renderBudgetItems();
                selectTemplateDropdown.value = '';
                selectedTemplateQuantityInput.value = '';
            } else {
                showMessageBox('Template selecionado não encontrado.');
            }
        };

        function handleDeleteTemplate(templateId) {
            if (!window.firestoreDb || !window.currentUserId) {
                showMessageBox('Erro: Banco de dados não disponível ou usuário não autenticado.');
                return;
            }
            try {
                window.deleteDoc(window.doc(window.firestoreDb, `artifacts/${__app_id}/users/${window.currentUserId}/savedTemplates`, templateId));
                showMessageBox('Template removido com sucesso!');
            } catch (error) {
                console.error("Erro ao remover template:", error);
                showMessageBox("Erro ao remover o template.");
            }
        }

        generateBudgetButton.onclick = () => {
            if (items.length === 0) {
                showMessageBox('Por favor, adicione itens ao orçamento antes de gerar a visualização.');
                return;
            }
            clientName = clientNameInput.value;
            clientPhone = clientPhoneInput.value;
            
            document.getElementById('budget-date').textContent = new Date().toLocaleDateString();
            document.getElementById('budget-user-id').textContent = window.currentUserId;
            document.getElementById('preview-client-name').textContent = clientName || 'Não Informado';
            document.getElementById('preview-client-phone').textContent = clientPhone || 'Não Informado';

            const budgetItemsPreviewTable = document.getElementById('budget-items-preview');
            budgetItemsPreviewTable.innerHTML = '';
            items.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'bg-white'; // ou bg-gray-50 para linhas alternadas
                row.innerHTML = `
                    <td class="py-3 px-4 border-b border-gray-300 text-gray-800">${item.name}</td>
                    <td class="py-3 px-4 border-b border-gray-300 text-center text-gray-800">${item.quantity}</td>
                    <td class="py-3 px-4 border-b border-gray-300 text-right text-gray-800">R$ ${item.unitPrice.toFixed(2)}</td>
                    <td class="py-3 px-4 border-b border-gray-300 text-right text-gray-800">R$ ${(item.quantity * item.unitPrice).toFixed(2)}</td>
                `;
                budgetItemsPreviewTable.appendChild(row);
            });
            document.getElementById('budget-total-preview').textContent = `R$ ${total.toFixed(2)}`;
            document.getElementById('budget-downpayment-preview').textContent = `R$ ${(total * 0.5).toFixed(2)}`;

            mainAppContainer.classList.add('hidden');
            budgetPreviewContainer.classList.remove('hidden');
        };

        closePreviewButton.onclick = () => {
            budgetPreviewContainer.classList.add('hidden');
            mainAppContainer.classList.remove('hidden');
        };

        generateImageButton.onclick = () => {
            if (!budgetContentToCapture) {
                showMessageBox('Erro: Conteúdo do orçamento não encontrado para gerar a imagem.');
                return;
            }

            if (typeof window.html2canvas === 'undefined') {
                showMessageBox('Aguarde... a biblioteca de geração de imagem está carregando.');
                return;
            }

            const buttonsToHide = budgetContentToCapture.closest('.max-w-3xl').querySelectorAll('.print\\:hidden');
            buttonsToHide.forEach(btn => btn.style.visibility = 'hidden');

            window.html2canvas(budgetContentToCapture, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
            }).then(canvas => {
                buttonsToHide.forEach(btn => btn.style.visibility = 'visible');

                const image = canvas.toDataURL("image/png");
                const link = document.createElement('a');
                link.href = image;
                link.download = `orcamento-${clientName || 'cliente'}-${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessageBox('Imagem do orçamento gerada com sucesso!');
            }).catch(error => {
                console.error("Erro ao gerar imagem:", error);
                showMessageBox("Erro ao gerar a imagem do orçamento. Verifique o console para detalhes.");
                buttonsToHide.forEach(btn => btn.style.visibility = 'visible');
            });
        };

        // Renderização inicial
        renderBudgetItems();

    </script>
</body>
</html>
